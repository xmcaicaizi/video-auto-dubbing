# 代码审查规范

本文档基于 [Google Engineering Practices](https://google.github.io/eng-practices/) 制定，定义了代码审查的标准流程和检查要点。

## 参考资源

- [Google Engineering Practices - Code Review](https://google.github.io/eng-practices/review/)
- [Google Engineering Practices - The CL Author's Guide](https://google.github.io/eng-practices/review/developer/)

## 代码审查的目标

1. **代码质量**：确保代码符合项目规范，功能正确
2. **知识共享**：通过审查传播知识和最佳实践
3. **一致性**：保持代码库风格和架构的一致性
4. **可维护性**：确保代码易于理解和维护

## CL（Change List）规模

### 小变更优先

- **理想大小**：200-400 行代码
- **最大建议**：不超过 1000 行
- **超大变更**：必须拆分为多个小的、独立的 CL

**为什么小变更更好？**
- 审查更快，更容易发现问题
- 降低引入 bug 的风险
- 更容易回滚
- 减少合并冲突

### 如何拆分大变更

1. **按功能拆分**：每个 CL 实现一个完整的功能
2. **按层次拆分**：先改数据层，再改业务层，最后改接口层
3. **重构与功能分离**：先重构，再添加新功能

## CL 描述规范

### 必需信息

每个 CL 必须包含：

1. **标题**：简洁描述变更内容（50 字以内）
2. **正文**：详细说明变更内容、动机和影响
3. **测试说明**：如何验证变更

### 标题格式

```
简短描述变更内容（动词开头）
```

示例：
```
添加任务状态查询 API
修复音频提取时的内存泄漏
重构 TTS 服务错误处理
```

### 正文模板

```markdown
## 变更内容
- 简要列出主要变更点

## 动机
- 为什么需要这个变更？
- 解决了什么问题？

## 影响
- 对现有功能的影响
- 是否需要数据库迁移？
- 是否需要配置变更？
- 是否向后兼容？

## 测试
- 如何测试这个变更？
- 测试用例覆盖情况
- 手动测试步骤（如适用）

## 相关 Issue
- Fixes #123
- Related to #456
```

### 示例

```markdown
## 变更内容
- 添加 `/api/v1/tasks/:id` 接口用于查询任务状态
- 实现任务状态缓存，减少数据库查询
- 添加任务状态变更的日志记录

## 动机
用户反馈无法实时查询任务处理进度，需要提供状态查询接口。

## 影响
- 新增 API 端点，不影响现有功能
- 使用 Redis 缓存，需要配置 Redis 连接
- 向后兼容

## 测试
- 单元测试：`TestGetTaskStatus` 覆盖所有状态
- 集成测试：验证缓存命中率
- 手动测试：使用 curl 测试 API 响应

## 相关 Issue
- Fixes #45
```

## 审查检查清单

### 功能正确性

- [ ] 代码实现了需求描述的功能
- [ ] 边界情况已处理
- [ ] 错误处理完整
- [ ] 无明显的逻辑错误

### 代码质量

- [ ] 代码符合项目规范（参考 [代码规范](coding-standards.md)）
- [ ] 代码已格式化（`gofmt`/`black`）
- [ ] 静态检查通过（`golangci-lint`/`ruff`）
- [ ] 命名清晰，易于理解
- [ ] 函数职责单一，长度合理
- [ ] 无重复代码

### 测试

- [ ] 新增代码包含测试
- [ ] 测试覆盖关键路径
- [ ] 测试用例清晰，易于理解
- [ ] 所有测试通过

### 文档

- [ ] 导出函数/类型有文档注释
- [ ] 复杂逻辑有注释说明
- [ ] API 变更已更新文档
- [ ] README/CHANGELOG 已更新（如适用）

### 性能

- [ ] 无明显性能问题
- [ ] 数据库查询已优化（如适用）
- [ ] 无内存泄漏风险
- [ ] 并发安全（如适用）

### 安全

- [ ] 无硬编码的密钥或敏感信息
- [ ] 输入验证完整
- [ ] 日志中无敏感信息泄露
- [ ] 依赖无已知安全漏洞

### 架构一致性

- [ ] 符合项目架构设计
- [ ] 遵循设计模式（如适用）
- [ ] 与其他模块集成良好
- [ ] 无循环依赖

## 审查流程

### 1. 提交前自检

在请求审查前，作者应：

1. 运行所有检查工具（`make lint`）
2. 运行所有测试（`make test`）
3. 自我审查代码
4. 确保 CL 描述完整

### 2. 请求审查

- 在 PR 中清晰描述变更
- 指定审查者（至少 1 人）
- 添加相关标签（如 `bug`, `feature`, `refactor`）

### 3. 审查过程

**审查者应：**

- 在 24 小时内响应（工作日）
- 仔细阅读代码和描述
- 提出建设性意见
- 对事不对人
- 认可好的做法

**作者应：**

- 及时响应审查意见
- 解释设计决策（如需要）
- 对合理的建议进行修改
- 保持专业和礼貌

### 4. 审查意见类型

- **必须修改（Must）**：功能错误、安全问题、违反规范
- **建议修改（Should）**：代码质量、可读性、性能优化
- **可选改进（Nice to have）**：风格偏好、未来优化

### 5. 批准与合并

- 至少 1 个审查者批准
- 所有 CI 检查通过
- 解决所有"必须修改"的意见
- 作者确认可以合并

## 审查最佳实践

### 对审查者

1. **保持礼貌和尊重**
   - 使用"建议"而非"必须"
   - 解释为什么需要修改
   - 认可好的代码

2. **关注代码，而非作者**
   - 避免个人攻击
   - 就事论事

3. **提供建设性反馈**
   - 不仅指出问题，还提供解决方案
   - 解释最佳实践

4. **及时响应**
   - 尽快开始审查
   - 不要拖延

### 对作者

1. **保持开放心态**
   - 审查是为了提高代码质量
   - 接受合理的建议

2. **解释设计决策**
   - 如果审查者不理解，解释原因
   - 但也要考虑是否真的需要这样设计

3. **及时响应**
   - 尽快处理审查意见
   - 如有疑问，主动沟通

4. **不要过度防御**
   - 承认错误并改正
   - 从审查中学习

## 常见审查场景

### 重构

- **要求**：重构不应改变功能行为
- **检查**：确保所有测试通过，功能一致

### Bug 修复

- **要求**：包含回归测试
- **检查**：确保修复彻底，无副作用

### 性能优化

- **要求**：提供性能测试数据
- **检查**：确保优化有效，无功能退化

### 新功能

- **要求**：完整的测试和文档
- **检查**：符合架构设计，易于维护

## 审查工具

- **GitHub Pull Requests**：代码审查界面
- **CI/CD**：自动运行检查和测试
- **代码审查工具**：如 `Reviewable`（可选）

## 争议处理

如果审查者与作者意见不一致：

1. **讨论**：在 PR 中公开讨论
2. **寻求第三方意见**：邀请其他团队成员
3. **技术负责人决策**：如仍无法达成一致，由技术负责人决定

## 持续改进

- 定期回顾审查流程
- 收集反馈，优化规范
- 分享审查经验和最佳实践

