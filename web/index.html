<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频本地化自动配音系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
        }

        .upload-section.dragover {
            border-color: #667eea;
            background: #e7f3ff;
        }

        input[type="file"] {
            display: none;
        }

        .upload-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }

        .upload-btn:hover {
            background: #5568d3;
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .form-group {
            margin: 15px 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .tasks-section {
            margin-top: 30px;
        }

        .task-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .task-id {
            font-family: monospace;
            color: #666;
            font-size: 14px;
        }

        .task-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-created { background: #e3f2fd; color: #1976d2; }
        .status-queued { background: #fff3e0; color: #f57c00; }
        .status-running { background: #e8f5e9; color: #388e3c; }
        .status-done { background: #e8f5e9; color: #2e7d32; }
        .status-failed { background: #ffebee; color: #c62828; }

        .task-progress {
            margin: 10px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s;
        }

        .task-actions {
            margin-top: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .error {
            color: #c62828;
            margin-top: 10px;
            padding: 10px;
            background: #ffebee;
            border-radius: 6px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .settings-panel {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            width: 380px;
            max-height: 80vh;
            overflow-y: auto;
            background: white;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 9999;
        }

        .settings-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .settings-note {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .settings-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px;
        }

        .download-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-right: 10px;
        }

        .task-meta {
            margin-top: 6px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>视频本地化自动配音系统</h1>

        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 20px;">
            <div></div>
            <button class="upload-btn" style="background:#f0f0f0; color:#333;" onclick="openSettings()">设置</button>
        </div>

        <div class="upload-section" id="uploadSection">
            <h2>上传视频文件</h2>
            <input type="file" id="videoFile" accept="video/*">
            <button class="upload-btn" onclick="document.getElementById('videoFile').click()">选择视频文件</button>
            <span id="fileName"></span>

            <div class="form-group">
                <label for="sourceLang">源语言</label>
                <select id="sourceLang">
                    <option value="zh">中文</option>
                    <option value="en">英语</option>
                    <option value="ja">日语</option>
                    <option value="ko">韩语</option>
                </select>
            </div>

            <div class="form-group">
                <label for="targetLang">目标语言</label>
                <select id="targetLang">
                    <option value="en">英语</option>
                    <option value="zh">中文</option>
                    <option value="ja">日语</option>
                    <option value="ko">韩语</option>
                </select>
            </div>

            <button class="upload-btn" id="submitBtn" onclick="uploadVideo()">开始处理</button>
        </div>

        <div class="tasks-section">
            <h2>任务列表</h2>
            <div id="tasksList"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';
        const SETTINGS_STORAGE_KEY = 'vedio_settings_v1';

        function getSettings() {
            try {
                const raw = localStorage.getItem(SETTINGS_STORAGE_KEY);
                return raw ? JSON.parse(raw) : {};
            } catch (_) {
                return {};
            }
        }

        function setSettings(next) {
            localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(next || {}));
        }

        function openSettings() {
            const s = getSettings();
            document.getElementById('asr_appid').value = s.asr_appid || '';
            document.getElementById('asr_token').value = s.asr_token || '';
            document.getElementById('asr_cluster').value = s.asr_cluster || '';
            document.getElementById('asr_api_key').value = s.asr_api_key || '';
            document.getElementById('glm_api_key').value = s.glm_api_key || '';
            document.getElementById('glm_model').value = s.glm_model || 'glm-4.5';
            document.getElementById('glm_api_url').value = s.glm_api_url || 'https://open.bigmodel.cn/api/paas/v4/chat/completions';
            document.getElementById('modelscope_token').value = s.modelscope_token || '';
            document.getElementById('settingsPanel').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsPanel').style.display = 'none';
        }

        function saveSettings() {
            const next = {
                asr_appid: (document.getElementById('asr_appid').value || '').trim(),
                asr_token: (document.getElementById('asr_token').value || '').trim(),
                asr_cluster: (document.getElementById('asr_cluster').value || '').trim(),
                asr_api_key: (document.getElementById('asr_api_key').value || '').trim(),
                glm_api_key: (document.getElementById('glm_api_key').value || '').trim(),
                glm_model: (document.getElementById('glm_model').value || 'glm-4.5').trim(),
                glm_api_url: (document.getElementById('glm_api_url').value || 'https://open.bigmodel.cn/api/paas/v4/chat/completions').trim(),
                modelscope_token: (document.getElementById('modelscope_token').value || '').trim(),
            };
            setSettings(next);
            closeSettings();
            alert('设置已保存（仅本浏览器）');
        }

        // 上传视频
        async function uploadVideo() {
            const fileInput = document.getElementById('videoFile');
            const sourceLang = document.getElementById('sourceLang').value;
            const targetLang = document.getElementById('targetLang').value;
            const submitBtn = document.getElementById('submitBtn');

            if (!fileInput.files[0]) {
                alert('请选择视频文件');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = '上传中...';

            const formData = new FormData();
            formData.append('video', fileInput.files[0]);
            formData.append('source_language', sourceLang);
            formData.append('target_language', targetLang);
            const settings = getSettings();
            if (settings.asr_appid) formData.append('asr_appid', settings.asr_appid);
            if (settings.asr_token) formData.append('asr_token', settings.asr_token);
            if (settings.asr_cluster) formData.append('asr_cluster', settings.asr_cluster);
            if (settings.asr_api_key) formData.append('asr_api_key', settings.asr_api_key);
            if (settings.glm_api_key) formData.append('glm_api_key', settings.glm_api_key);
            if (settings.glm_model) formData.append('glm_model', settings.glm_model);
            if (settings.glm_api_url) formData.append('glm_api_url', settings.glm_api_url);
            if (settings.modelscope_token) formData.append('modelscope_token', settings.modelscope_token);

            try {
                const response = await fetch(`${API_BASE}/tasks`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (data.code === 0) {
                    alert('任务创建成功！');
                    fileInput.value = '';
                    document.getElementById('fileName').textContent = '';
                    loadTasks();
                } else {
                    alert('创建任务失败: ' + data.message);
                }
            } catch (error) {
                alert('上传失败: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '开始处理';
            }
        }

        // 加载任务列表
        async function loadTasks() {
            try {
                const response = await fetch(`${API_BASE}/tasks`);
                const data = await response.json();
                
                if (data.code === 0) {
                    const tasks = data.data.tasks || [];
                    const detailTasks = await Promise.all(tasks.map(async (task) => {
                        try {
                            const detailResp = await fetch(`${API_BASE}/tasks/${task.task_id}`);
                            const detailData = await detailResp.json();
                            if (detailData.code === 0) {
                                return { ...task, ...detailData.data };
                            }
                        } catch (_) {
                        }
                        return task;
                    }));
                    renderTasks(detailTasks);
                }
            } catch (error) {
                console.error('加载任务失败:', error);
            }
        }

        // 渲染任务列表
        function renderTasks(tasks) {
            const tasksList = document.getElementById('tasksList');
            
            if (tasks.length === 0) {
                tasksList.innerHTML = '<div class="loading">暂无任务</div>';
                return;
            }

            tasksList.innerHTML = tasks.map(task => `
                <div class="task-item">
                    <div class="task-header">
                        <div>
                            <div class="task-id">任务 ID: ${task.task_id}</div>
                            <div style="margin-top: 5px; color: #666;">
                                ${task.source_language && task.target_language ? `${task.source_language} → ${task.target_language}` : '语言信息待更新'}
                            </div>
                            ${task.created_at ? `<div class="task-meta">创建时间: ${formatDate(task.created_at)}</div>` : ''}
                        </div>
                        <span class="task-status status-${task.status}">${getStatusText(task.status)}</span>
                    </div>
                    <div class="task-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${task.progress}%"></div>
                        </div>
                        <div style="margin-top: 5px; font-size: 12px; color: #666;">${task.progress}%</div>
                    </div>
                    ${task.error ? `<div class="error">错误: ${task.error}</div>` : ''}
                    <div class="task-actions">
                        ${task.status === 'done' ? 
                            `<select class="download-select" id="downloadType-${task.task_id}">
                                <option value="video">视频</option>
                                <option value="audio">配音音频</option>
                                <option value="subtitle">字幕</option>
                            </select>
                            <button class="btn btn-primary" onclick="downloadTask('${task.task_id}')">下载结果</button>` : 
                            ''
                        }
                        <button class="btn" onclick="refreshTask('${task.task_id}')">刷新</button>
                    </div>
                </div>
            `).join('');

            // 自动刷新运行中的任务
            tasks.filter(t => t.status === 'running' || t.status === 'queued').forEach(task => {
                setTimeout(() => refreshTask(task.task_id), 3000);
            });
        }

        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'created': '已创建',
                'queued': '已排队',
                'running': '处理中',
                'done': '已完成',
                'failed': '失败'
            };
            return statusMap[status] || status;
        }

        function formatDate(isoString) {
            try {
                const date = new Date(isoString);
                return date.toLocaleString();
            } catch (_) {
                return isoString;
            }
        }

        // 刷新任务状态
        async function refreshTask(taskId) {
            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}`);
                const data = await response.json();
                
                if (data.code === 0) {
                    loadTasks();
                }
            } catch (error) {
                console.error('刷新任务失败:', error);
            }
        }

        // 下载任务结果
        async function downloadTask(taskId) {
            try {
                const select = document.getElementById(`downloadType-${taskId}`);
                const downloadType = select ? select.value : 'video';
                const response = await fetch(`${API_BASE}/tasks/${taskId}/download?type=${encodeURIComponent(downloadType)}`);
                const data = await response.json();
                
                if (data.code === 0 && data.data.download_url) {
                    window.open(data.data.download_url, '_blank');
                } else {
                    alert('获取下载链接失败');
                }
            } catch (error) {
                alert('下载失败: ' + error.message);
            }
        }

        // 文件选择处理
        document.getElementById('videoFile').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || '';
            document.getElementById('fileName').textContent = fileName ? `已选择: ${fileName}` : '';
        });

        // 页面加载时获取任务列表
        loadTasks();
        setInterval(loadTasks, 5000); // 每5秒刷新一次
        // Settings UI (simple inline panel)
        document.addEventListener('DOMContentLoaded', () => {
            const panel = document.createElement('div');
            panel.id = 'settingsPanel';
            panel.className = 'settings-panel';
            panel.innerHTML = `
                <div class="settings-title">
                    <div style="font-weight:700; color:#333;">设置</div>
                    <button class="btn" onclick="closeSettings()">✕</button>
                </div>
                <div class="settings-note">保存到 localStorage，创建任务时提交给后端。</div>
                <div class="form-group"><label>ASR App ID</label><input id="asr_appid" placeholder="your_asr_appid" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"></div>
                <div class="form-group"><label>ASR Token</label><input id="asr_token" placeholder="your_asr_token" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"></div>
                <div class="form-group"><label>ASR Cluster</label><input id="asr_cluster" placeholder="volcengine_streaming_common" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"></div>
                <div class="form-group"><label>ASR API Key（豆包语音）</label><input id="asr_api_key" placeholder="your_asr_api_key" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"></div>
                <div class="form-group"><label>GLM API Key</label><input id="glm_api_key" placeholder="your_glm_api_key" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"></div>
                <div class="form-group"><label>GLM API URL</label><input id="glm_api_url" placeholder="https://open.bigmodel.cn/api/paas/v4/chat/completions" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"></div>
                <div class="form-group"><label>GLM Model</label><input id="glm_model" placeholder="glm-4.5" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"></div>
                <div class="form-group"><label>ModelScope Token</label><input id="modelscope_token" placeholder="your_modelscope_token" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"></div>
                <div class="settings-actions">
                    <button class="btn" onclick="closeSettings()">取消</button>
                    <button class="upload-btn" onclick="saveSettings()">保存</button>
                </div>
            `;
            document.body.appendChild(panel);
        });
    </script>
</body>
</html>
