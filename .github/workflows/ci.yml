name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Go 代码检查
  go:
    name: Go Lint & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ matrix.service }}
    
    strategy:
      matrix:
        service: [api, worker]
        include:
          - service: api
            path: api
          - service: worker
            path: worker
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: ${{ matrix.path }}/go.sum
      
      - name: Install dependencies
        run: |
          cd ${{ matrix.path }}
          go mod download
      
      - name: Install goimports
        run: go install golang.org/x/tools/cmd/goimports@latest
      
      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: v1.55.2
          working-directory: ${{ matrix.path }}
      
      - name: Check formatting
        run: |
          cd ${{ matrix.path }}
          # 检查 gofmt
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "❌ 代码未格式化，请运行: gofmt -w ."
            gofmt -d .
            exit 1
          fi
          # 检查 goimports
          if [ "$(goimports -l . | wc -l)" -gt 0 ]; then
            echo "❌ 导入未格式化，请运行: goimports -w ."
            goimports -d .
            exit 1
          fi
          echo "✅ 代码格式检查通过"
      
      - name: Run golangci-lint
        run: |
          cd ${{ matrix.path }}
          golangci-lint run
      
      - name: Run tests
        run: |
          cd ${{ matrix.path }}
          go test ./... -v -race -coverprofile=coverage.out
      
      - name: Upload coverage
        if: matrix.service == 'api'
        uses: codecov/codecov-action@v4
        with:
          file: ./${{ matrix.path }}/coverage.out
          flags: ${{ matrix.service }}
          name: ${{ matrix.service }}-coverage

  # Python 代码检查
  python:
    name: Python Lint & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: tts_service
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          uv sync --frozen
      
      - name: Check formatting (black)
        run: |
          uv run black --check .
      
      - name: Run ruff
        run: |
          uv run ruff check .
      
      - name: Run tests
        run: |
          uv run pytest -v --cov=app --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./tts_service/coverage.xml
          flags: python
          name: python-coverage

  # Shell 脚本检查
  shell:
    name: Shell Script Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install shfmt
        run: |
          go install mvdan.cc/sh/v3/cmd/shfmt@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
      
      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
      
      - name: Check formatting (shfmt)
        run: |
          # 查找所有 .sh 文件
          sh_files=$(find . -name "*.sh" -type f -not -path "*/\.*" -not -path "*/node_modules/*")
          if [ -z "$sh_files" ]; then
            echo "ℹ️  未找到 Shell 脚本文件"
            exit 0
          fi
          
          # 检查格式
          for file in $sh_files; do
            echo "检查 $file..."
            if ! shfmt -d "$file"; then
              echo "❌ $file 格式不正确，请运行: shfmt -w $file"
              exit 1
            fi
          done
          echo "✅ Shell 脚本格式检查通过"
      
      - name: Run shellcheck
        run: |
          # 查找所有 .sh 文件
          sh_files=$(find . -name "*.sh" -type f -not -path "*/\.*" -not -path "*/node_modules/*")
          if [ -z "$sh_files" ]; then
            echo "ℹ️  未找到 Shell 脚本文件"
            exit 0
          fi
          
          # 运行 shellcheck
          for file in $sh_files; do
            echo "检查 $file..."
            shellcheck "$file" || exit 1
          done
          echo "✅ Shell 脚本检查通过"

  # Markdown 检查（可选）
  markdown:
    name: Markdown Lint
    runs-on: ubuntu-latest
    continue-on-error: true  # 标记为可选，不影响整体 CI
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run markdownlint
        uses: DavidAnson/markdownlint-action@v3
        with:
          globs: '**/*.md'

  # 综合检查（确保所有作业通过）
  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [go, python, shell]
    
    steps:
      - name: All checks passed
        run: echo "✅ 所有检查通过！"

