name: Format Check

on:
  pull_request:
    branches: [ main, develop ]

# 此工作流专门检查代码格式，在 PR 中提供更清晰的反馈
jobs:
  format:
    name: Code Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check Go formatting
        if: hashFiles('api/**/*.go', 'worker/**/*.go') != ''
        run: |
          echo "检查 Go 代码格式..."
          failed=0
          
          for dir in api worker; do
            if [ -d "$dir" ]; then
              echo "检查 $dir/..."
              cd "$dir"
              
              # 检查 gofmt
              if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
                echo "❌ $dir: 代码未格式化"
                echo "请运行: cd $dir && gofmt -w ."
                gofmt -d . | head -20
                failed=1
              fi
              
              # 检查 goimports
              go install golang.org/x/tools/cmd/goimports@latest
              if [ "$(goimports -l . | wc -l)" -gt 0 ]; then
                echo "❌ $dir: 导入未格式化"
                echo "请运行: cd $dir && goimports -w ."
                goimports -d . | head -20
                failed=1
              fi
              
              cd ..
            fi
          done
          
          if [ $failed -eq 1 ]; then
            exit 1
          fi
          echo "✅ Go 代码格式检查通过"
      
      - name: Install uv
        if: hashFiles('tts_service/**/*.py') != ''
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Set up Python
        if: hashFiles('tts_service/**/*.py') != ''
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Check Python formatting
        if: hashFiles('tts_service/**/*.py') != ''
        working-directory: tts_service
        run: |
          echo "检查 Python 代码格式..."
          uv sync --frozen
          uv run black --check . || {
            echo "❌ Python 代码未格式化"
            echo "请运行: cd tts_service && uv run black ."
            exit 1
          }
          echo "✅ Python 代码格式检查通过"
      
      - name: Check Shell formatting
        if: hashFiles('**/*.sh') != ''
        run: |
          echo "检查 Shell 脚本格式..."
          
          go install mvdan.cc/sh/v3/cmd/shfmt@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          
          sh_files=$(find . -name "*.sh" -type f -not -path "*/\.*" -not -path "*/node_modules/*")
          if [ -z "$sh_files" ]; then
            echo "ℹ️  未找到 Shell 脚本文件"
            exit 0
          fi
          
          failed=0
          for file in $sh_files; do
            if ! shfmt -d "$file" > /dev/null 2>&1; then
              echo "❌ $file 格式不正确"
              echo "请运行: shfmt -w $file"
              shfmt -d "$file" | head -20
              failed=1
            fi
          done
          
          if [ $failed -eq 1 ]; then
            exit 1
          fi
          echo "✅ Shell 脚本格式检查通过"

