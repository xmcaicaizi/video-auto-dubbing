# 阿里云统一平台迁移 - 工作流程图

> 📊 **可视化工作流程** - 从初始化到上线的完整流程

---

## 🗺️ 总体工作流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        迁移工作流程                              │
└─────────────────────────────────────────────────────────────────┘

    ┌──────────────┐
    │ 1. 阅读文档  │
    │ (5分钟)      │
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ 2. 初始化    │
    │ 运行脚本     │
    │ (1分钟)      │
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │ 3. 选择任务  │
    │ 切换worktree │
    │ (1分钟)      │
    └──────┬───────┘
           │
           ▼
    ┌──────────────────────────────────┐
    │ 4. 并行开发 (5人同时进行)        │
    ├──────────────────────────────────┤
    │ ASR  │ OSS  │ LLM  │ TTS  │ 清理 │
    └──┬────┴──┬───┴──┬───┴──┬───┴──┬──┘
       │       │      │      │      │
       ▼       ▼      ▼      ▼      ▼
    ┌──────────────────────────────────┐
    │ 5. 每日提交 (使用 commit_all.sh) │
    └──────────────┬───────────────────┘
                   │
                   ▼
    ┌──────────────────────────┐
    │ 6. 主分支集成测试         │
    │ (在 aliyun-migration)    │
    └──────────┬───────────────┘
               │
               ▼
    ┌──────────────────────────┐
    │ 7. 验收测试              │
    │ - 单元测试               │
    │ - 集成测试               │
    │ - 性能测试               │
    └──────────┬───────────────┘
               │
               ▼
    ┌──────────────────────────┐
    │ 8. 合并到 main           │
    │ 上线部署                 │
    └──────────────────────────┘
```

---

## 📂 Git Worktree 架构

```
                    ┌─────────────────────┐
                    │   main (生产分支)    │
                    └──────────┬──────────┘
                               │
                    ┌──────────▼──────────────────────────┐
                    │ feature/aliyun-unified-migration    │
                    │ (主迁移分支 - 集成测试)              │
                    └─────────────┬───────────────────────┘
                                  │
                ┌─────────────────┼─────────────────┐
                │                 │                 │
    ┌───────────▼──────────┐  ┌──▼───────┐  ┌─────▼────────┐
    │ feature/aliyun-      │  │ feature/ │  │ feature/     │
    │ asr-default          │  │ aliyun-  │  │ cleanup-     │
    │                      │  │ oss-     │  │ legacy-      │
    │ ~/worktrees/         │  │ default  │  │ services     │
    │ video-dubbing/       │  │          │  │              │
    │ asr-default/         │  │ ...      │  │ ...          │
    └──────────────────────┘  └──────────┘  └──────────────┘

    每个分支有独立的工作目录，可以并行开发
```

---

## 🔄 每日工作流程

```
┌─────────────────────────────────────────────────────┐
│              开发者每日工作流程                      │
└─────────────────────────────────────────────────────┘

早上 (9:00):
    │
    ├─ cd ~/worktrees/video-dubbing/aliyun-migration
    ├─ git pull origin feature/aliyun-unified-migration
    │  (拉取最新的集成代码)
    │
    └─ source ~/worktrees/video-dubbing/goto.sh asr
       (切换到自己的任务)

开发时间 (9:30-17:30):
    │
    ├─ 编写代码
    ├─ go test ./... -v (运行测试)
    ├─ git add . && git commit -m "feat: ..."
    │  (定期提交)
    │
    └─ 遇到问题 → 查看 CHEATSHEET.md

晚上 (18:00):
    │
    ├─ cd ~/worktrees/video-dubbing
    ├─ ./commit_all.sh "feat: daily progress"
    │  (批量提交所有任务)
    │
    └─ 更新 MIGRATION_CHECKLIST.md
       (标记完成的任务)
```

---

## 🧪 测试工作流程

```
┌────────────────────────────────────────────────────┐
│                 测试流程                            │
└────────────────────────────────────────────────────┘

Step 1: 单元测试 (在各自的 worktree)
    │
    ├─ cd ~/worktrees/video-dubbing/asr-default
    ├─ go test ./worker/internal/asr/... -v
    └─ 覆盖率检查: go test -coverprofile=coverage.out

Step 2: 集成测试 (在主迁移分支)
    │
    ├─ cd ~/worktrees/video-dubbing/aliyun-migration
    ├─ docker-compose -f docker-compose.test.yml up -d
    ├─ go test ./tests/integration/... -v
    └─ docker-compose -f docker-compose.test.yml down

Step 3: 性能测试
    │
    ├─ ./scripts/performance_comparison.sh
    └─ 对比新旧系统性能

Step 4: 验收测试
    │
    ├─ 完整视频处理流程
    ├─ 所有语言对测试
    ├─ 压力测试 (并发10+任务)
    └─ 长时间运行测试 (24小时)

✅ 所有测试通过 → 合并到 main
```

---

## 🚀 部署工作流程

```
┌────────────────────────────────────────────────────┐
│               部署上线流程                          │
└────────────────────────────────────────────────────┘

开发环境:
    │
    ├─ 在 worktree 中开发
    ├─ 单元测试
    └─ 提交到子任务分支

测试环境:
    │
    ├─ 合并到主迁移分支
    ├─ 集成测试
    └─ 性能测试

预生产环境:
    │
    ├─ 创建 PR: feature/aliyun-unified-migration → main
    ├─ Code Review
    ├─ 最终验收测试
    └─ PR 批准

生产环境:
    │
    ├─ 合并 PR 到 main
    ├─ 自动部署 (CI/CD)
    ├─ 监控指标
    └─ 逐步放量 (金丝雀部署)
```

---

## 📊 任务依赖关系

```
┌────────────────────────────────────────────────────┐
│             任务间的依赖关系                        │
└────────────────────────────────────────────────────┘

Phase 1: ASR 迁移
    │
    │ (可并行)
    ▼
Phase 2: OSS 迁移
    │
    │ (可并行)        Phase 3: LLM 翻译迁移
    │                    │
    └────────────────────┘
                         │
                         ▼
                    Phase 4: TTS 迁移
                         │
                         ▼
                    Phase 5: 清理遗留服务
                         │
                         ▼
                    最终验证 & 合并

说明:
- Phase 1, 2, 3 可以完全并行
- Phase 4 建议在 Phase 1-3 完成后开始 (但不强制)
- Phase 5 必须等所有前置任务完成
```

---

## 🔀 分支合并策略

```
┌────────────────────────────────────────────────────┐
│              分支合并流程                           │
└────────────────────────────────────────────────────┘

每天下班前:
    │
    ├─ 子任务分支提交
    │  git push origin feature/aliyun-asr-default
    │
    └─ 合并到主迁移分支
       cd ~/worktrees/video-dubbing/aliyun-migration
       git merge feature/aliyun-asr-default

每个阶段完成后:
    │
    ├─ 主迁移分支运行完整测试
    ├─ 所有测试通过
    └─ 标记里程碑 (Tag)
       git tag -a milestone-asr-complete -m "ASR migration complete"

所有阶段完成后:
    │
    ├─ 创建 Pull Request
    │  feature/aliyun-unified-migration → main
    │
    ├─ Code Review
    ├─ 最终验收
    └─ 合并到 main
       git checkout main
       git merge --no-ff feature/aliyun-unified-migration
       git push origin main
```

---

## 🐛 问题处理流程

```
┌────────────────────────────────────────────────────┐
│            遇到问题的处理流程                       │
└────────────────────────────────────────────────────┘

遇到问题
    │
    ▼
┌────────────────┐
│ 查看文档       │
│ - CHEATSHEET   │  ────→ 解决 → 继续开发
│ - 故障排除     │
└────────┬───────┘
         │ 未解决
         ▼
┌────────────────┐
│ 搜索 Issues    │  ────→ 找到答案 → 继续开发
└────────┬───────┘
         │ 未找到
         ▼
┌────────────────┐
│ 团队群聊提问   │  ────→ 得到帮助 → 继续开发
└────────┬───────┘
         │ 仍未解决
         ▼
┌────────────────┐
│ 联系负责人     │  ────→ 专业支持 → 继续开发
└────────┬───────┘
         │ 系统性问题
         ▼
┌────────────────┐
│ 创建 Issue     │
│ 记录详细信息   │
│ 安排技术讨论   │
└────────────────┘
```

---

## 📈 进度追踪流程

```
┌────────────────────────────────────────────────────┐
│              进度管理流程                           │
└────────────────────────────────────────────────────┘

每日 (18:00):
    │
    ├─ 更新任务状态
    │  编辑 MIGRATION_CHECKLIST.md
    │  [ ] → [x] (标记完成的任务)
    │
    ├─ 记录每日站会
    │  在 MIGRATION_CHECKLIST.md 底部添加
    │  - 完成了什么
    │  - 遇到什么问题
    │  - 明天计划做什么
    │
    └─ 推送到远程
       git add docs/migration/MIGRATION_CHECKLIST.md
       git commit -m "docs: update daily progress"
       git push

每周 (周五):
    │
    ├─ 检查里程碑
    │  对比预期 vs 实际进度
    │
    ├─ 更新风险项
    │  MIGRATION_CHECKLIST.md 的风险表
    │
    └─ 团队周会
       - 本周完成情况
       - 下周计划
       - 风险和阻塞项

项目结束:
    │
    ├─ 最终验收
    ├─ 性能报告
    ├─ 成本分析
    └─ 经验总结文档
```

---

## 🎯 验收流程

```
┌────────────────────────────────────────────────────┐
│              最终验收流程                           │
└────────────────────────────────────────────────────┘

Step 1: 功能验收
    │
    ├─ [ ] 所有服务使用阿里云作为默认
    ├─ [ ] 所有遗留服务已下线
    ├─ [ ] 完整视频处理流程正常
    └─ [ ] 所有语言对翻译准确

Step 2: 性能验收
    │
    ├─ [ ] ASR 处理速度 ≥ 火山引擎
    ├─ [ ] 翻译速度提升 ≥ 20%
    ├─ [ ] TTS 合成速度 ≥ IndexTTS
    └─ [ ] 文件存储访问速度满足要求

Step 3: 质量验收
    │
    ├─ [ ] 单元测试覆盖率 > 80%
    ├─ [ ] 集成测试通过率 = 100%
    ├─ [ ] 无高危安全漏洞
    └─ [ ] 日志和监控完整

Step 4: 成本验收
    │
    ├─ [ ] GPU 服务器成本已移除
    ├─ [ ] OSS 成本在预算内
    ├─ [ ] API 调用成本可控
    └─ [ ] 总成本降低 ≥ 30%

Step 5: 文档验收
    │
    ├─ [ ] 所有文档更新完成
    ├─ [ ] 配置示例准确
    ├─ [ ] 故障排除指南完整
    └─ [ ] 迁移指南清晰

✅ 所有验收通过 → 签署上线审批 → 合并到 main
```

---

## 📞 沟通流程

```
┌────────────────────────────────────────────────────┐
│              团队沟通机制                           │
└────────────────────────────────────────────────────┘

每日站会 (10分钟):
    │
    ├─ 时间: 每天 10:00
    ├─ 每人分享 (2分钟):
    │  - 昨天做了什么
    │  - 今天计划做什么
    │  - 遇到什么阻塞
    │
    └─ 记录在 MIGRATION_CHECKLIST.md

技术讨论 (按需):
    │
    ├─ 遇到技术难题
    ├─ 架构设计变更
    └─ 性能优化方案

周会 (30分钟):
    │
    ├─ 时间: 每周五 16:00
    ├─ 议程:
    │  - 本周进度回顾
    │  - 下周计划
    │  - 风险识别
    │  - 经验分享
    │
    └─ 会议纪要发送到团队邮件

Code Review:
    │
    ├─ 每个 PR 需要至少 1 人 Review
    ├─ Review 标准:
    │  - 代码质量
    │  - 测试覆盖
    │  - 文档完整
    │  - 性能影响
    │
    └─ 通过后合并
```

---

## 🎊 上线流程

```
┌────────────────────────────────────────────────────┐
│              生产环境上线流程                       │
└────────────────────────────────────────────────────┘

上线前 (T-1天):
    │
    ├─ 最终验收测试
    ├─ 性能压测
    ├─ 准备回滚方案
    └─ 发送上线通知

上线当天 (T):
    │
    ├─ 08:00 - 备份数据库
    ├─ 09:00 - 合并代码到 main
    ├─ 09:30 - CI/CD 自动部署
    ├─ 10:00 - 验证部署成功
    │
    ├─ 10:00-12:00 - 灰度发布 (10% 流量)
    ├─ 监控关键指标:
    │  - 错误率
    │  - 响应时间
    │  - API 调用成功率
    │
    ├─ 12:00-14:00 - 增加到 50% 流量
    ├─ 继续监控
    │
    └─ 14:00-18:00 - 100% 流量
       最终验证

上线后 (T+1 至 T+7):
    │
    ├─ 持续监控性能指标
    ├─ 收集用户反馈
    ├─ 快速响应问题
    └─ 一周后总结复盘

如遇问题:
    │
    ├─ 立即回滚
    ├─ 分析原因
    ├─ 修复后重新上线
    └─ 更新故障手册
```

---

## 📋 清单检查点

### 开始前检查
- [ ] 已阅读所有文档
- [ ] 已运行初始化脚本
- [ ] 已分配任务负责人
- [ ] 已配置开发环境

### 开发中检查 (每天)
- [ ] 代码符合规范
- [ ] 测试全部通过
- [ ] 已提交到远程
- [ ] 更新了进度清单

### 阶段完成检查
- [ ] 所有任务已完成
- [ ] 集成测试通过
- [ ] 性能达标
- [ ] 文档已更新

### 上线前检查
- [ ] 最终验收通过
- [ ] 回滚方案就绪
- [ ] 监控告警配置
- [ ] 团队已通知

---

**最后更新**: 2026-02-02
**版本**: v1.0

**💡 提示**: 将此流程图作为日常工作参考，确保每一步都按流程执行！
