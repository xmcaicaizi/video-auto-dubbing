# 设置功能设计方案

## 一、需求分析

### 1.1 当前状态

- 前端已有简单的设置面板，存储在 `localStorage`
- 设置项随任务创建时提交 (`asr_appid`, `asr_token`, `glm_api_key` 等)
- 存储在 `tasks` 表的各任务记录中 (per-task 配置)
- 没有全局持久化配置

### 1.2 需求目标

1. **支持新的服务配置**：火山引擎 ASR、远程 TTS (index-tts-vllm)
2. **持久化存储**：后端数据库存储，支持多端同步
3. **配置优先级**：任务级 > 用户级 > 系统默认
4. **安全性**：敏感信息加密存储

---

## 二、架构设计

### 2.1 配置层级

```
┌─────────────────────────────────────────────────────────────┐
│                       配置优先级                             │
├─────────────────────────────────────────────────────────────┤
│  1. 任务级配置 (tasks 表)           ← 最高优先级            │
│     - 创建任务时可覆盖特定配置                               │
│                                                             │
│  2. 用户/全局设置 (settings 表)     ← 用户保存的默认配置     │
│     - 前端设置面板保存                                       │
│     - 后端 API 持久化                                        │
│                                                             │
│  3. 系统默认 (环境变量/config)       ← 最低优先级            │
│     - docker-compose.yml / .env                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 数据流

```
前端设置面板
    ↓ 保存
POST /api/v1/settings
    ↓
后端存储到 settings 表
    ↓
创建任务时
    ↓
Worker 读取配置 (任务级 > 设置表 > 环境变量)
```

---

## 三、数据库设计

### 3.1 新建 settings 表

```sql
CREATE TABLE IF NOT EXISTS settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- 配置分类
    category VARCHAR(50) NOT NULL,  -- 'asr', 'tts', 'translate', 'general'

    -- 配置键值
    key VARCHAR(100) NOT NULL,
    value TEXT,                      -- 加密存储敏感信息
    is_encrypted BOOLEAN DEFAULT FALSE,

    -- 元数据
    description TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(category, key)
);

CREATE INDEX IF NOT EXISTS idx_settings_category ON settings(category);
```

### 3.2 配置项定义

| Category | Key | Description | Sensitive |
|----------|-----|-------------|-----------|
| asr | volcengine_app_key | 火山引擎 APP ID | ✓ |
| asr | volcengine_access_key | 火山引擎 Access Token | ✓ |
| asr | volcengine_resource_id | 资源 ID | |
| asr | enable_speaker_info | 说话人分离 | |
| asr | enable_emotion | 情绪检测 | |
| asr | enable_gender | 性别检测 | |
| tts | service_url | TTS 服务地址 | |
| tts | api_key | TTS API 密钥 | ✓ |
| tts | backend | 后端类型 (vllm/legacy) | |
| translate | glm_api_key | GLM API Key | ✓ |
| translate | glm_api_url | GLM API URL | |
| translate | glm_model | GLM 模型 | |

---

## 四、API 设计

### 4.1 获取设置

```
GET /api/v1/settings
GET /api/v1/settings?category=asr

Response:
{
  "code": 0,
  "data": {
    "asr": {
      "volcengine_app_key": "xxx***xxx",  // 敏感信息脱敏
      "volcengine_resource_id": "volc.bigasr.auc",
      "enable_speaker_info": true,
      ...
    },
    "tts": {
      "service_url": "https://xxx.autodl.pro:6006",
      "backend": "vllm",
      ...
    },
    "translate": {
      "glm_api_key": "xxx***xxx",
      "glm_model": "glm-4-flash",
      ...
    }
  }
}
```

### 4.2 更新设置

```
PUT /api/v1/settings
Content-Type: application/json

Request:
{
  "asr": {
    "volcengine_app_key": "your_app_key",
    "volcengine_access_key": "your_access_key",
    "volcengine_resource_id": "volc.bigasr.auc",
    "enable_speaker_info": true,
    "enable_emotion": true,
    "enable_gender": true
  },
  "tts": {
    "service_url": "https://xxx.autodl.pro:6006",
    "api_key": "",
    "backend": "vllm"
  },
  "translate": {
    "glm_api_key": "your_glm_key",
    "glm_api_url": "https://open.bigmodel.cn/api/paas/v4/chat/completions",
    "glm_model": "glm-4-flash"
  }
}

Response:
{
  "code": 0,
  "message": "设置已保存"
}
```

### 4.3 测试连接

```
POST /api/v1/settings/test
Content-Type: application/json

Request:
{
  "type": "asr"  // or "tts", "translate"
}

Response:
{
  "code": 0,
  "data": {
    "status": "connected",
    "message": "火山引擎 ASR 连接成功",
    "latency_ms": 120
  }
}
```

---

## 五、前端设计

### 5.1 设置面板改进

```
┌─────────────────────────────────────────────────────────────┐
│  设置                                              [×]      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [ASR 服务] [TTS 服务] [翻译服务]    ← Tab 切换             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  ┌─ ASR 服务 (火山引擎) ─────────────────────────────────┐  │
│  │                                                       │  │
│  │  App Key:     [________________________] [测试]       │  │
│  │  Access Key:  [________________________]              │  │
│  │  资源 ID:     [volc.bigasr.auc      ▼]               │  │
│  │                                                       │  │
│  │  ☑ 说话人分离  ☑ 情绪检测  ☑ 性别检测               │  │
│  │                                                       │  │
│  │  状态: ● 已连接                                       │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌─ TTS 服务 (index-tts-vllm) ───────────────────────────┐  │
│  │                                                       │  │
│  │  服务地址:   [https://xxx.autodl.pro:6006] [测试]     │  │
│  │  API Key:    [________________________] (可选)        │  │
│  │  后端类型:   [vllm ▼]                                 │  │
│  │                                                       │  │
│  │  状态: ● 已连接                                       │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                             │
│                              [取消]  [保存设置]             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 交互流程

```
1. 打开设置 → 调用 GET /api/v1/settings 加载当前配置
2. 编辑配置 → 本地暂存
3. 点击"测试" → 调用 POST /api/v1/settings/test 验证连接
4. 点击"保存" → 调用 PUT /api/v1/settings 持久化
5. 创建任务 → 自动使用已保存的设置
```

---

## 六、后端实现

### 6.1 文件结构

```
api/internal/
├── handlers/
│   ├── task.go
│   └── settings.go      ← 新增
├── models/
│   ├── task.go
│   └── settings.go      ← 新增
├── service/
│   ├── task.go
│   └── settings.go      ← 新增
└── database/
    └── migrations.go    ← 添加 settings 表
```

### 6.2 核心代码结构

```go
// handlers/settings.go
type SettingsHandler struct {
    service *service.SettingsService
    logger  *zap.Logger
}

func (h *SettingsHandler) GetSettings(c *gin.Context)
func (h *SettingsHandler) UpdateSettings(c *gin.Context)
func (h *SettingsHandler) TestConnection(c *gin.Context)

// models/settings.go
type Settings struct {
    ASR       ASRSettings       `json:"asr"`
    TTS       TTSSettings       `json:"tts"`
    Translate TranslateSettings `json:"translate"`
}

type ASRSettings struct {
    VolcengineAppKey     string `json:"volcengine_app_key"`
    VolcengineAccessKey  string `json:"volcengine_access_key"`
    VolcengineResourceID string `json:"volcengine_resource_id"`
    EnableSpeakerInfo    bool   `json:"enable_speaker_info"`
    EnableEmotion        bool   `json:"enable_emotion"`
    EnableGender         bool   `json:"enable_gender"`
}

type TTSSettings struct {
    ServiceURL string `json:"service_url"`
    APIKey     string `json:"api_key"`
    Backend    string `json:"backend"`
}

type TranslateSettings struct {
    GLMAPIKey string `json:"glm_api_key"`
    GLMAPIURL string `json:"glm_api_url"`
    GLMModel  string `json:"glm_model"`
}
```

---

## 七、Worker 配置读取

### 7.1 配置合并逻辑

```go
// worker 启动时或处理任务时
func (w *Worker) getEffectiveConfig(ctx context.Context, taskID uuid.UUID) (*EffectiveConfig, error) {
    // 1. 从环境变量加载系统默认
    cfg := w.config

    // 2. 从 settings 表加载用户设置 (覆盖默认)
    settings, _ := w.loadGlobalSettings(ctx)
    cfg = cfg.MergeWith(settings)

    // 3. 从 tasks 表加载任务级配置 (最高优先)
    taskSettings, _ := w.loadTaskSettings(ctx, taskID)
    cfg = cfg.MergeWith(taskSettings)

    return cfg, nil
}
```

---

## 八、开发计划

### Phase 1: 后端 API (Day 1)
- [ ] 创建 settings 表迁移
- [ ] 实现 models/settings.go
- [ ] 实现 service/settings.go
- [ ] 实现 handlers/settings.go
- [ ] 注册路由

### Phase 2: 前端界面 (Day 1-2)
- [ ] 重构设置面板 HTML/CSS
- [ ] 实现 Tab 切换
- [ ] 实现 API 调用 (GET/PUT)
- [ ] 实现连接测试

### Phase 3: Worker 集成 (Day 2)
- [ ] 实现配置合并逻辑
- [ ] ASR 步骤读取设置
- [ ] TTS 步骤读取设置
- [ ] 翻译步骤读取设置

### Phase 4: 测试与优化 (Day 3)
- [ ] 端到端测试
- [ ] 敏感信息加密
- [ ] 错误处理优化

---

## 九、安全考虑

### 9.1 敏感信息处理

1. **存储加密**：API Key 等敏感信息使用 AES 加密存储
2. **传输安全**：HTTPS
3. **响应脱敏**：GET 返回时对敏感字段脱敏显示 (`xxx***xxx`)
4. **日志过滤**：日志中不打印敏感信息

### 9.2 加密实现

```go
// 使用 AES-256-GCM 加密
func encryptValue(plaintext string, key []byte) (string, error)
func decryptValue(ciphertext string, key []byte) (string, error)

// 加密密钥从环境变量读取
SETTINGS_ENCRYPTION_KEY=your-32-byte-key
```

---

## 十、兼容性

### 10.1 向后兼容

- 保留 `tasks` 表中的 per-task 配置字段
- 优先使用任务级配置，fallback 到全局设置
- 前端 `localStorage` 作为临时缓存

### 10.2 迁移策略

- 新 settings 表独立于现有表
- 不影响现有任务处理流程
- 渐进式迁移，先实现后端，再更新前端
