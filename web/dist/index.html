<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘æœ¬åœ°åŒ–è‡ªåŠ¨é…éŸ³ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* å·¦ä¾§ä»»åŠ¡åˆ—è¡¨ */
        .task-list-panel {
            width: 320px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .task-list-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-list-header h2 {
            font-size: 18px;
            color: #333;
        }

        .new-task-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .new-task-btn:hover {
            background: #5568d3;
        }

        .settings-btn {
            background: #f0f0f0;
            color: #333;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 8px;
        }

        .settings-btn:hover {
            background: #e6e6e6;
        }

        /* Settings modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal {
            width: 720px;
            max-width: calc(100% - 40px);
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 700;
            color: #333;
        }

        .modal-close {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #666;
        }

        .modal-note {
            font-size: 12px;
            color: #666;
            margin-bottom: 14px;
            line-height: 1.5;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .settings-section {
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 12px;
        }

        .settings-section h3 {
            font-size: 13px;
            color: #333;
            margin-bottom: 10px;
        }

        .field {
            margin-bottom: 10px;
        }

        .field label {
            display: block;
            font-size: 12px;
            color: #555;
            margin-bottom: 6px;
        }

        .field input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 12px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 14px;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-secondary:hover {
            background: #e6e6e6;
        }

        .btn-danger {
            background: #ffebee;
            color: #c62828;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-danger:hover {
            background: #ffd7dc;
        }

        .task-list-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .task-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .task-item:hover {
            background: #f8f9fa;
        }

        .task-item.selected {
            background: #e7f3ff;
            border-color: #667eea;
        }

        .task-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .task-id {
            font-family: monospace;
            font-size: 12px;
            color: #666;
        }

        .task-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-created { background: #e3f2fd; color: #1976d2; }
        .status-queued { background: #fff3e0; color: #f57c00; }
        .status-running { background: #e8f5e9; color: #388e3c; }
        .status-done { background: #e8f5e9; color: #2e7d32; }
        .status-failed { background: #ffebee; color: #c62828; }

        .task-info {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .task-progress {
            margin-top: 8px;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .task-progress-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s;
        }

        /* å³ä¾§å·¥ä½œå° */
        .workbench-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: white;
        }

        /* è§†é¢‘é¢„è§ˆåŒº */
        .video-preview {
            height: 50%;
            background: #000;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-preview video {
            max-width: 100%;
            max-height: 100%;
        }

        .video-upload-area {
            text-align: center;
            color: #999;
        }

        .video-upload-area.dragover {
            background: #e7f3ff;
        }

        .upload-controls {
            margin-top: 20px;
        }

        .upload-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 10px;
        }

        .upload-btn:hover {
            background: #5568d3;
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        input[type="file"] {
            display: none;
        }

        .task-progress-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
        }

        .task-progress-info .progress-text {
            margin-top: 8px;
            font-size: 12px;
            color: #ccc;
        }

        /* åº•éƒ¨ä¸‰æ  */
        .control-panels {
            height: 50%;
            display: flex;
            border-top: 1px solid #e0e0e0;
        }

        .control-panel {
            flex: 1;
            border-right: 1px solid #e0e0e0;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .control-panel:last-child {
            border-right: none;
        }

        .panel-header {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* éŸ³é¢‘ç”Ÿæˆé¢æ¿ */
        .audio-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .audio-upload-area:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .audio-upload-area.dragover {
            border-color: #667eea;
            background: #e7f3ff;
        }

        .audio-waveform {
            width: 100%;
            height: 80px;
            background: #f0f0f0;
            border-radius: 4px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 12px;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .audio-control-btn {
            background: #f0f0f0;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .audio-control-btn:hover {
            background: #e0e0e0;
        }

        .audio-time {
            font-size: 12px;
            color: #666;
            min-width: 60px;
            text-align: center;
        }

        /* æ–‡æœ¬é¢æ¿ */
        .text-content {
            flex: 1;
            overflow-y: auto;
        }

        .text-input {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
        }

        .text-input:disabled {
            background: #f5f5f5;
            color: #666;
        }

        .segments-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .segment-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .segment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
            color: #666;
        }

        .segment-text {
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
        }

        .segment-mt-text {
            font-size: 14px;
            color: #667eea;
            font-weight: 500;
        }

        .generate-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: 16px;
            font-weight: 600;
        }

        .generate-btn:hover {
            background: #45a049;
        }

        .generate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ç”Ÿæˆç»“æœé¢æ¿ */
        .result-audio {
            margin-bottom: 16px;
        }

        .download-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .download-btn:hover {
            background: #5568d3;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§ä»»åŠ¡åˆ—è¡¨ -->
        <div class="task-list-panel">
            <div class="task-list-header">
                <h2>ä»»åŠ¡åˆ—è¡¨</h2>
                <div style="display:flex; align-items:center;">
                    <button class="settings-btn" onclick="openSettings()">è®¾ç½®</button>
                    <button class="new-task-btn" onclick="showUploadDialog()">æ–°å»ºä»»åŠ¡</button>
                </div>
            </div>
            <div class="task-list-content" id="taskList"></div>
        </div>

        <!-- å³ä¾§å·¥ä½œå° -->
        <div class="workbench-panel">
            <!-- è§†é¢‘é¢„è§ˆåŒº -->
            <div class="video-preview" id="videoPreview">
                <div class="video-upload-area" id="videoUploadArea">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¹</div>
                    <div style="font-size: 16px; margin-bottom: 8px;">ä¸Šä¼ ä¸­æ–‡è§†é¢‘æ–‡ä»¶</div>
                    <div style="font-size: 12px; color: #999;">æ”¯æŒæ‹–æ‹½ä¸Šä¼ ï¼Œå°†ç”Ÿæˆç›¸åŒæ—¶é•¿çš„è‹±æ–‡é…éŸ³è§†é¢‘</div>
                    <div class="upload-controls">
                        <button class="upload-btn" onclick="document.getElementById('videoFileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
                        <input type="file" id="videoFileInput" accept="video/*" onchange="handleVideoFileSelect(event)">
                    </div>
                </div>
                <div id="videoPlayerContainer" style="display: none; position: relative; width: 100%; height: 100%;">
                    <div style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; z-index: 10;">
                        è‹±æ–‡é…éŸ³è§†é¢‘
                    </div>
                    <video id="videoPlayer" controls style="width: 100%; height: 100%; object-fit: contain;"></video>
                </div>
                <div class="task-progress-info" id="taskProgressInfo" style="display: none;">
                    <div>ä»»åŠ¡å¤„ç†ä¸­...</div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
            </div>

            <!-- åº•éƒ¨ä¸‰æ  -->
            <div class="control-panels">
                <!-- éŸ³é¢‘ç”Ÿæˆé¢æ¿ -->
                <div class="control-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <span>éŸ³è‰²å‚è€ƒéŸ³é¢‘</span>
                        </div>
                    </div>
                    <div class="audio-upload-area" id="audioUploadArea" onclick="document.getElementById('audioFileInput').click()">
                        <div style="font-size: 24px; margin-bottom: 8px;">ğŸ¤</div>
                        <div style="font-size: 12px; color: #999;">ç‚¹å‡»ä¸Šä¼ å‚è€ƒéŸ³é¢‘</div>
                        <input type="file" id="audioFileInput" accept="audio/*" onchange="handleAudioFileSelect(event)">
                    </div>
                    <div id="audioPlayerArea" style="display: none;">
                        <div class="audio-waveform" id="audioWaveform">éŸ³é¢‘æ³¢å½¢</div>
                        <div class="audio-controls">
                            <button class="audio-control-btn" onclick="audioRewind()">â®</button>
                            <button class="audio-control-btn" id="audioPlayBtn" onclick="audioTogglePlay()">â–¶</button>
                            <button class="audio-control-btn" onclick="audioForward()">â­</button>
                            <div class="audio-time" id="audioTime">0:00 / 0:00</div>
                            <button class="audio-control-btn" onclick="audioLoop()">ğŸ”</button>
                        </div>
                        <audio id="audioPlayer" style="display: none;"></audio>
                    </div>
                </div>

                <!-- æ–‡æœ¬é¢æ¿ -->
                <div class="control-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <span>æ–‡æœ¬</span>
                        </div>
                        <span style="font-size: 12px; color: #999;">å½“å‰æ¨¡å‹ç‰ˆæœ¬2.0</span>
                    </div>
                    <div class="text-content">
                        <textarea class="text-input" id="textInput" placeholder="ç­‰å¾…ä»»åŠ¡å®Œæˆåæ˜¾ç¤ºè¯†åˆ«å’Œç¿»è¯‘çš„æ–‡æœ¬..."></textarea>
                        <div id="segmentsList" style="display: none;"></div>
                        <button class="generate-btn" id="generateBtn" onclick="generateVideo()" disabled>ç”Ÿæˆ</button>
                    </div>
                </div>

                <!-- ç”Ÿæˆç»“æœé¢æ¿ -->
                <div class="control-panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <span>ç”Ÿæˆç»“æœ</span>
                        </div>
                        <button class="download-btn" id="downloadBtn" onclick="downloadResult()" style="display: none;">
                            <span>â¬‡</span>
                            <span>ä¸‹è½½</span>
                        </button>
                    </div>
                    <div id="resultContent">
                        <div class="empty-state">ç­‰å¾…ç”Ÿæˆç»“æœ...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">è®¾ç½®ï¼ˆAPI Key æŒä¹…åŒ–åˆ°æœ¬åœ°æµè§ˆå™¨ï¼‰</div>
                <button class="modal-close" onclick="closeSettings()">âœ•</button>
            </div>
            <div class="modal-note">
                è¿™äº› Key ä¼šä¿å­˜åœ¨æµè§ˆå™¨çš„ <code>localStorage</code> ä¸­ï¼ˆä»…æœ¬æœºå¯è§ï¼‰ã€‚åˆ›å»ºä»»åŠ¡æ—¶ä¼šéšè¯·æ±‚å‘ç»™åç«¯å¹¶å†™å…¥ä»»åŠ¡è¡¨ï¼Œç”¨äº Worker å¼‚æ­¥å¤„ç†ã€‚è¯·å‹¿åœ¨ä¸å¯ä¿¡ç”µè„‘ä¸Šä¿å­˜ã€‚
            </div>
            <div class="settings-grid">
                <div class="settings-section">
                    <h3>æŠ–éŸ³/ç«å±± ASRï¼ˆappid/token/clusterï¼‰</h3>
                    <div class="field">
                        <label>ASR AppID</label>
                        <input id="asrAppid" placeholder="your_appid">
                    </div>
                    <div class="field">
                        <label>ASR Token</label>
                        <input id="asrToken" placeholder="your_token">
                    </div>
                    <div class="field">
                        <label>ASR Cluster</label>
                        <input id="asrCluster" placeholder="your_cluster">
                    </div>
                </div>
                <div class="settings-section">
                    <h3>æ™ºè°± GLMï¼ˆBigModelï¼‰</h3>
                    <div class="field">
                        <label>GLM API Key</label>
                        <input id="glmApiKey" placeholder="your_glm_api_key">
                    </div>
                    <div class="field">
                        <label>GLM Modelï¼ˆé»˜è®¤ glm-4.5ï¼‰</label>
                        <input id="glmModel" placeholder="glm-4.5">
                    </div>
                </div>
                <div class="settings-section" style="grid-column: span 2;">
                    <h3>é­”æ­ ModelScope / IndexTTS-2</h3>
                    <div class="field">
                        <label>ModelScope Token</label>
                        <input id="modelscopeToken" placeholder="your_modelscope_token">
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-danger" onclick="clearSettings()">æ¸…é™¤</button>
                <button class="btn-secondary" onclick="closeSettings()">å–æ¶ˆ</button>
                <button class="new-task-btn" onclick="saveSettings()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';
        let currentTaskId = null;
        let pollInterval = null;
        let audioFile = null;
        let audioPlayer = null;
        const SETTINGS_STORAGE_KEY = 'vedio_settings_v1';

        function getSettings() {
            try {
                const raw = localStorage.getItem(SETTINGS_STORAGE_KEY);
                return raw ? JSON.parse(raw) : {};
            } catch (_) {
                return {};
            }
        }

        function setSettings(next) {
            localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(next || {}));
        }

        function openSettings() {
            const s = getSettings();
            document.getElementById('asrAppid').value = s.asr_appid || '';
            document.getElementById('asrToken').value = s.asr_token || '';
            document.getElementById('asrCluster').value = s.asr_cluster || '';
            document.getElementById('glmApiKey').value = s.glm_api_key || '';
            document.getElementById('glmModel').value = s.glm_model || 'glm-4.5';
            document.getElementById('modelscopeToken').value = s.modelscope_token || '';
            document.getElementById('settingsOverlay').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('settingsOverlay').style.display = 'none';
        }

        function saveSettings() {
            const next = {
                asr_appid: (document.getElementById('asrAppid').value || '').trim(),
                asr_token: (document.getElementById('asrToken').value || '').trim(),
                asr_cluster: (document.getElementById('asrCluster').value || '').trim(),
                glm_api_key: (document.getElementById('glmApiKey').value || '').trim(),
                glm_model: (document.getElementById('glmModel').value || 'glm-4.5').trim(),
                modelscope_token: (document.getElementById('modelscopeToken').value || '').trim(),
            };
            setSettings(next);
            closeSettings();
            alert('è®¾ç½®å·²ä¿å­˜ï¼ˆä»…æœ¬æµè§ˆå™¨ï¼‰');
        }

        function clearSettings() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤å·²ä¿å­˜çš„ Key å—ï¼Ÿ')) return;
            setSettings({});
            openSettings();
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadTasks();
            setupDragAndDrop();
            audioPlayer = document.getElementById('audioPlayer');
        });

        // è®¾ç½®æ‹–æ‹½ä¸Šä¼ 
        function setupDragAndDrop() {
            const videoArea = document.getElementById('videoUploadArea');
            const audioArea = document.getElementById('audioUploadArea');

            [videoArea, audioArea].forEach(area => {
                area.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    area.classList.add('dragover');
                });

                area.addEventListener('dragleave', () => {
                    area.classList.remove('dragover');
                });

                area.addEventListener('drop', (e) => {
                    e.preventDefault();
                    area.classList.remove('dragover');
                    if (area === videoArea) {
                        handleVideoFile(e.dataTransfer.files[0]);
                    } else {
                        handleAudioFile(e.dataTransfer.files[0]);
                    }
                });
            });
        }

        // æ˜¾ç¤ºä¸Šä¼ å¯¹è¯æ¡†
        function showUploadDialog() {
            document.getElementById('videoFileInput').click();
        }

        // å¤„ç†è§†é¢‘æ–‡ä»¶é€‰æ‹©
        function handleVideoFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleVideoFile(file);
            }
        }

        // å¤„ç†è§†é¢‘æ–‡ä»¶
        async function handleVideoFile(file) {
            const formData = new FormData();
            formData.append('video', file);
            formData.append('source_language', 'zh');
            formData.append('target_language', 'en');
            const settings = getSettings();
            if (settings.asr_appid) formData.append('asr_appid', settings.asr_appid);
            if (settings.asr_token) formData.append('asr_token', settings.asr_token);
            if (settings.asr_cluster) formData.append('asr_cluster', settings.asr_cluster);
            if (settings.glm_api_key) formData.append('glm_api_key', settings.glm_api_key);
            if (settings.glm_model) formData.append('glm_model', settings.glm_model);
            if (settings.modelscope_token) formData.append('modelscope_token', settings.modelscope_token);

            const uploadArea = document.getElementById('videoUploadArea');
            uploadArea.innerHTML = '<div class="loading">ä¸Šä¼ ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/tasks`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (data.code === 0) {
                    currentTaskId = data.data.task_id;
                    loadTasks();
                    selectTask(currentTaskId);
                    startPolling(currentTaskId);
                } else {
                    alert('åˆ›å»ºä»»åŠ¡å¤±è´¥: ' + data.message);
                    uploadArea.innerHTML = `
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“¹</div>
                        <div style="font-size: 16px; margin-bottom: 8px;">ä¸Šä¼ è§†é¢‘æ–‡ä»¶</div>
                        <div style="font-size: 12px; color: #999;">æ”¯æŒæ‹–æ‹½ä¸Šä¼ </div>
                        <div class="upload-controls">
                            <button class="upload-btn" onclick="document.getElementById('videoFileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
                        </div>
                    `;
                }
            } catch (error) {
                alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½ä»»åŠ¡åˆ—è¡¨
        async function loadTasks() {
            try {
                const response = await fetch(`${API_BASE}/tasks`);
                const data = await response.json();
                
                if (data.code === 0) {
                    renderTasks(data.data.tasks || []);
                }
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTasks(tasks) {
            const taskList = document.getElementById('taskList');
            
            if (tasks.length === 0) {
                taskList.innerHTML = '<div class="empty-state">æš‚æ— ä»»åŠ¡</div>';
                return;
            }

            taskList.innerHTML = tasks.map(task => `
                <div class="task-item ${task.task_id === currentTaskId ? 'selected' : ''}" 
                     onclick="selectTask('${task.task_id}')">
                    <div class="task-item-header">
                        <div class="task-id">${task.task_id.substring(0, 8)}...</div>
                        <span class="task-status status-${task.status}">${getStatusText(task.status)}</span>
                    </div>
                    <div class="task-info">
                        ${task.source_language || 'zh'} â†’ ${task.target_language || 'en'}
                    </div>
                    <div class="task-progress">
                        <div class="task-progress-fill" style="width: ${task.progress || 0}%"></div>
                    </div>
                </div>
            `).join('');
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'created': 'å·²åˆ›å»º',
                'queued': 'å·²æ’é˜Ÿ',
                'running': 'å¤„ç†ä¸­',
                'done': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥'
            };
            return statusMap[status] || status;
        }

        // é€‰æ‹©ä»»åŠ¡
        async function selectTask(taskId) {
            currentTaskId = taskId;
            loadTasks();
            await loadTaskDetail(taskId);
            startPolling(taskId);
        }

        // åŠ è½½ä»»åŠ¡è¯¦æƒ…
        async function loadTaskDetail(taskId) {
            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}`);
                const data = await response.json();
                
                if (data.code === 0) {
                    updateTaskDetail(data.data);
                }
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ä»»åŠ¡è¯¦æƒ…
        function updateTaskDetail(task) {
            const videoPreview = document.getElementById('videoPreview');
            const videoPlayer = document.getElementById('videoPlayer');
            const videoPlayerContainer = document.getElementById('videoPlayerContainer');
            const videoUploadArea = document.getElementById('videoUploadArea');
            const progressInfo = document.getElementById('taskProgressInfo');
            const progressText = document.getElementById('progressText');
            const textInput = document.getElementById('textInput');
            const segmentsList = document.getElementById('segmentsList');
            const generateBtn = document.getElementById('generateBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const resultContent = document.getElementById('resultContent');

            // æ›´æ–°è¿›åº¦ä¿¡æ¯
            if (task.status === 'running' || task.status === 'queued') {
                progressInfo.style.display = 'block';
                progressText.textContent = `${task.progress || 0}%`;
                videoUploadArea.style.display = 'none';
                videoPlayerContainer.style.display = 'none';
            } else if (task.status === 'done') {
                progressInfo.style.display = 'none';
                videoUploadArea.style.display = 'none';
                loadResultVideo(task.task_id);
            } else if (task.status === 'failed') {
                progressInfo.style.display = 'none';
                videoPlayerContainer.style.display = 'none';
                videoUploadArea.style.display = 'block';
                videoUploadArea.innerHTML = `<div style="color: #c62828; padding: 20px;">ä»»åŠ¡å¤±è´¥: ${task.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
            }

            // åŠ è½½ä»»åŠ¡ç»“æœï¼ˆæ–‡æœ¬å’ŒéŸ³é¢‘ï¼‰
            if (task.status === 'done') {
                loadTaskResult(task.task_id);
                downloadBtn.style.display = 'flex';
            } else {
                downloadBtn.style.display = 'none';
            }
        }

        // åŠ è½½ç»“æœè§†é¢‘ï¼ˆè‹±æ–‡é…éŸ³è§†é¢‘ï¼‰
        async function loadResultVideo(taskId) {
            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}/download?type=video`);
                const data = await response.json();
                
                if (data.code === 0 && data.data.download_url) {
                    const videoPlayer = document.getElementById('videoPlayer');
                    const videoPlayerContainer = document.getElementById('videoPlayerContainer');
                    videoPlayer.src = data.data.download_url;
                    videoPlayerContainer.style.display = 'block';
                    
                    // è§†é¢‘åŠ è½½é”™è¯¯å¤„ç†
                    videoPlayer.addEventListener('error', () => {
                        console.error('è§†é¢‘åŠ è½½å¤±è´¥');
                        videoPlayerContainer.innerHTML = '<div style="color: #c62828; padding: 20px;">è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·å°è¯•ä¸‹è½½</div>';
                    });
                }
            } catch (error) {
                console.error('åŠ è½½ç»“æœè§†é¢‘å¤±è´¥:', error);
                const videoPlayerContainer = document.getElementById('videoPlayerContainer');
                if (videoPlayerContainer) {
                    videoPlayerContainer.innerHTML = '<div style="color: #c62828; padding: 20px;">è·å–è§†é¢‘é“¾æ¥å¤±è´¥: ' + error.message + '</div>';
                    videoPlayerContainer.style.display = 'block';
                }
            }
        }

        // åŠ è½½ä»»åŠ¡ç»“æœ
        async function loadTaskResult(taskId) {
            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}/result`);
                const data = await response.json();
                
                if (data.code === 0) {
                    const segments = data.data.segments || [];
                    const textInput = document.getElementById('textInput');
                    const segmentsList = document.getElementById('segmentsList');

                    if (segments.length > 0) {
                        // æ˜¾ç¤ºåˆ†æ®µåˆ—è¡¨
                        segmentsList.style.display = 'block';
                        textInput.style.display = 'none';
                        segmentsList.innerHTML = segments.map(seg => `
                            <div class="segment-item">
                                <div class="segment-header">
                                    <span>ç‰‡æ®µ ${seg.idx + 1}</span>
                                    <span>${formatTime(seg.start_ms)} - ${formatTime(seg.end_ms)}</span>
                                </div>
                                <div class="segment-text">${seg.src_text || ''}</div>
                                <div class="segment-mt-text">${seg.mt_text || ''}</div>
                            </div>
                        `).join('');

                        // ç”Ÿæˆå®Œæ•´æ–‡æœ¬
                        const fullText = segments.map(seg => seg.mt_text || seg.src_text).join(' ');
                        textInput.value = fullText;
                    } else {
                        segmentsList.style.display = 'none';
                        textInput.style.display = 'block';
                    }

                    // åŠ è½½éŸ³é¢‘
                    if (segments.length > 0 && segments[0].tts_audio_url) {
                        loadResultAudio(taskId);
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡ç»“æœå¤±è´¥:', error);
            }
        }

        // åŠ è½½ç»“æœéŸ³é¢‘
        async function loadResultAudio(taskId) {
            try {
                const response = await fetch(`${API_BASE}/tasks/${taskId}/download?type=audio`);
                const data = await response.json();
                
                if (data.code === 0 && data.data.download_url) {
                    const resultContent = document.getElementById('resultContent');
                    resultContent.innerHTML = `
                        <div class="result-audio">
                            <div class="audio-waveform">éŸ³é¢‘æ³¢å½¢</div>
                            <div class="audio-controls">
                                <button class="audio-control-btn" onclick="resultAudioRewind()">â®</button>
                                <button class="audio-control-btn" id="resultAudioPlayBtn" onclick="resultAudioTogglePlay()">â–¶</button>
                                <button class="audio-control-btn" onclick="resultAudioForward()">â­</button>
                                <div class="audio-time" id="resultAudioTime">0:00 / 0:00</div>
                            </div>
                            <audio id="resultAudioPlayer" src="${data.data.download_url}" style="display: none;"></audio>
                        </div>
                    `;
                    setupResultAudioPlayer();
                }
            } catch (error) {
                console.error('åŠ è½½ç»“æœéŸ³é¢‘å¤±è´¥:', error);
            }
        }

        // è®¾ç½®ç»“æœéŸ³é¢‘æ’­æ”¾å™¨
        function setupResultAudioPlayer() {
            const player = document.getElementById('resultAudioPlayer');
            if (!player) return;

            player.addEventListener('loadedmetadata', () => {
                updateResultAudioTime();
            });

            player.addEventListener('timeupdate', () => {
                updateResultAudioTime();
            });

            player.addEventListener('ended', () => {
                const playBtn = document.getElementById('resultAudioPlayBtn');
                if (playBtn) playBtn.textContent = 'â–¶';
            });
        }

        // æ›´æ–°ç»“æœéŸ³é¢‘æ—¶é—´
        function updateResultAudioTime() {
            const player = document.getElementById('resultAudioPlayer');
            const timeEl = document.getElementById('resultAudioTime');
            if (player && timeEl) {
                const current = formatTime(Math.floor(player.currentTime * 1000));
                const total = formatTime(Math.floor(player.duration * 1000));
                timeEl.textContent = `${current} / ${total}`;
            }
        }

        // ç»“æœéŸ³é¢‘æ§åˆ¶
        function resultAudioTogglePlay() {
            const player = document.getElementById('resultAudioPlayer');
            const playBtn = document.getElementById('resultAudioPlayBtn');
            if (player && playBtn) {
                if (player.paused) {
                    player.play();
                    playBtn.textContent = 'â¸';
                } else {
                    player.pause();
                    playBtn.textContent = 'â–¶';
                }
            }
        }

        function resultAudioRewind() {
            const player = document.getElementById('resultAudioPlayer');
            if (player) {
                player.currentTime = Math.max(0, player.currentTime - 5);
            }
        }

        function resultAudioForward() {
            const player = document.getElementById('resultAudioPlayer');
            if (player) {
                player.currentTime = Math.min(player.duration, player.currentTime + 5);
            }
        }

        // å¼€å§‹è½®è¯¢
        function startPolling(taskId) {
            if (pollInterval) {
                clearInterval(pollInterval);
            }

            pollInterval = setInterval(async () => {
                const task = await loadTaskDetail(taskId);
                const response = await fetch(`${API_BASE}/tasks/${taskId}`);
                const data = await response.json();
                
                if (data.code === 0) {
                    if (data.data.status === 'done' || data.data.status === 'failed') {
                        clearInterval(pollInterval);
                        pollInterval = null;
                    }
                    updateTaskDetail(data.data);
                    loadTasks();
                }
            }, 2000);
        }

        // å¤„ç†éŸ³é¢‘æ–‡ä»¶é€‰æ‹©
        function handleAudioFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleAudioFile(file);
            }
        }

        // å¤„ç†éŸ³é¢‘æ–‡ä»¶
        function handleAudioFile(file) {
            audioFile = file;
            const audioUploadArea = document.getElementById('audioUploadArea');
            const audioPlayerArea = document.getElementById('audioPlayerArea');
            
            audioUploadArea.style.display = 'none';
            audioPlayerArea.style.display = 'block';
            
            const url = URL.createObjectURL(file);
            audioPlayer.src = url;
            
            audioPlayer.addEventListener('loadedmetadata', () => {
                updateAudioTime();
            });

            audioPlayer.addEventListener('timeupdate', () => {
                updateAudioTime();
            });
        }

        // éŸ³é¢‘æ§åˆ¶
        function audioTogglePlay() {
            const playBtn = document.getElementById('audioPlayBtn');
            if (audioPlayer.paused) {
                audioPlayer.play();
                playBtn.textContent = 'â¸';
            } else {
                audioPlayer.pause();
                playBtn.textContent = 'â–¶';
            }
        }

        function audioRewind() {
            audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
        }

        function audioForward() {
            audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 5);
        }

        function audioLoop() {
            audioPlayer.loop = !audioPlayer.loop;
        }

        function updateAudioTime() {
            const timeEl = document.getElementById('audioTime');
            if (timeEl && audioPlayer) {
                const current = formatTime(Math.floor(audioPlayer.currentTime * 1000));
                const total = formatTime(Math.floor(audioPlayer.duration * 1000));
                timeEl.textContent = `${current} / ${total}`;
            }
        }

        // ç”Ÿæˆè§†é¢‘
        async function generateVideo() {
            // MVP é˜¶æ®µï¼šæ­¤åŠŸèƒ½æš‚ä¸å®ç°ï¼Œä»…æç¤º
            alert('ç”ŸæˆåŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­å®ç°');
        }

        // ä¸‹è½½ç»“æœï¼ˆè‹±æ–‡é…éŸ³è§†é¢‘ï¼‰
        async function downloadResult() {
            if (!currentTaskId) return;

            try {
                const response = await fetch(`${API_BASE}/tasks/${currentTaskId}/download?type=video`);
                const data = await response.json();
                
                if (data.code === 0 && data.data.download_url) {
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const a = document.createElement('a');
                    a.href = data.data.download_url;
                    a.download = `dubbed_video_${currentTaskId.substring(0, 8)}.mp4`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                } else {
                    alert('è·å–ä¸‹è½½é“¾æ¥å¤±è´¥');
                }
            } catch (error) {
                alert('ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>

