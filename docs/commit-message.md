# 提交信息规范

本文档定义了本项目的 Git 提交信息规范，遵循 Google-style 提交信息格式。

## 格式规范

### 基本结构

```
简短描述（50 字以内，动词开头）

详细说明变更内容、动机和影响。

测试说明：如何验证这个变更。
```

### 标题行（第一行）

- **长度**：不超过 50 个字符
- **格式**：动词开头，使用现在时
- **语言**：中文（项目主要使用中文）
- **标点**：结尾不使用句号

**好的示例：**
```
添加任务状态查询 API
修复音频提取时的内存泄漏
重构 TTS 服务错误处理
更新部署文档
```

**不好的示例：**
```
添加任务状态查询 API。  # 不要使用句号
Added task status query API  # 使用中文
fix bug  # 描述不够清晰
```

### 正文（可选但推荐）

- **空行分隔**：标题和正文之间用空行分隔
- **内容**：详细说明变更内容、动机和影响
- **长度**：每行不超过 72 个字符（便于 Git 显示）
- **段落**：使用空行分隔段落

### 测试说明（可选但推荐）

- 说明如何验证这个变更
- 列出测试用例或手动测试步骤

## 完整示例

### 示例 1：新功能

```
添加任务状态查询 API

实现了 GET /api/v1/tasks/:id 接口，支持查询任务处理状态。
添加了 Redis 缓存以减少数据库查询压力。

影响：
- 新增 API 端点，不影响现有功能
- 需要配置 Redis 连接
- 向后兼容

测试说明：
- 单元测试覆盖所有状态码（200, 404, 500）
- 集成测试验证缓存命中率
- 手动测试：使用 curl 测试 API 响应
```

### 示例 2：Bug 修复

```
修复音频提取时的内存泄漏

在 extract_audio 步骤中，ffmpeg 进程未正确关闭导致内存泄漏。
现在确保所有子进程在函数返回前被正确清理。

影响：
- 修复内存泄漏问题
- 不影响功能，仅修复资源管理

测试说明：
- 添加了内存泄漏检测测试
- 运行长时间任务验证内存稳定
- 使用 pprof 工具验证修复
```

### 示例 3：重构

```
重构 TTS 服务错误处理

统一错误处理模式，使用自定义异常类型替代通用 Exception。
改进错误消息，包含更多上下文信息。

影响：
- 错误处理更清晰
- 不影响 API 接口
- 向后兼容

测试说明：
- 所有现有测试通过
- 新增错误处理测试用例
- 验证错误消息格式
```

### 示例 4：文档更新

```
更新部署文档

添加 Docker Compose 部署的详细步骤和故障排查指南。
更新环境变量配置说明。

测试说明：
- 按照新文档完成部署验证
- 检查所有链接有效
```

### 示例 5：小修复（可省略正文）

```
修复拼写错误

将 "recieve" 更正为 "receive"。
```

## 提交类型（可选前缀）

虽然不强制使用 Conventional Commits 格式，但可以在标题前添加类型前缀以提高可读性：

- `feat:` 新功能
- `fix:` Bug 修复
- `refactor:` 重构
- `docs:` 文档更新
- `test:` 测试相关
- `chore:` 构建/工具相关
- `perf:` 性能优化
- `style:` 代码格式（不影响功能）

**示例：**

```
feat: 添加任务状态查询 API
fix: 修复音频提取时的内存泄漏
refactor: 重构 TTS 服务错误处理
docs: 更新部署文档
```

## 提交信息检查清单

提交前确认：

- [ ] 标题清晰，动词开头
- [ ] 标题不超过 50 字符
- [ ] 正文详细说明变更（如适用）
- [ ] 包含测试说明（如适用）
- [ ] 使用中文
- [ ] 无拼写错误

## 多提交策略

### 何时拆分提交

- **逻辑独立**：每个提交实现一个完整的功能或修复
- **易于审查**：小提交更容易审查和理解
- **易于回滚**：如果某个提交有问题，可以单独回滚

### 提交顺序

1. **重构提交**：先提交重构，再提交新功能
2. **依赖关系**：按依赖顺序提交（底层先于上层）
3. **测试提交**：测试可以与功能一起提交，或单独提交

### 示例：拆分大变更

**不好的做法：**
```
实现任务处理流程

包含所有步骤的实现...
```

**好的做法：**
```
添加任务数据模型

定义 Task 和 TaskStep 结构体，包含状态枚举。

测试说明：单元测试验证数据模型。

---

实现音频提取步骤

实现 extract_audio worker 步骤，使用 ffmpeg 提取音频。

测试说明：集成测试验证音频提取功能。

---

实现语音识别步骤

实现 asr worker 步骤，调用 Moonshine ASR 服务。

测试说明：集成测试验证 ASR 调用。
```

## 与 Issue 关联

在提交信息或 PR 描述中关联 Issue：

```
添加任务状态查询 API

实现了 GET /api/v1/tasks/:id 接口。

Fixes #45
Related to #23
```

**关键词：**
- `Fixes #123`: 修复 Issue #123（合并后自动关闭）
- `Closes #123`: 关闭 Issue #123
- `Related to #123`: 相关但不直接关闭

## 工具支持

### Git Hooks

可以配置 `commit-msg` hook 检查提交信息格式（可选）：

```bash
#!/bin/sh
# .git/hooks/commit-msg

# 检查标题长度
title=$(head -n1 "$1")
if [ ${#title} -gt 50 ]; then
    echo "Error: Commit title exceeds 50 characters"
    exit 1
fi

# 检查是否以动词开头（简单检查）
if ! echo "$title" | grep -qE '^(添加|修复|重构|更新|删除|实现|优化|改进)'; then
    echo "Warning: Commit title should start with a verb"
fi
```

### IDE 插件

- **VS Code**: Git Commit Message Editor
- **IntelliJ**: Git Commit Template

## 常见问题

### Q: 提交信息必须用中文吗？

A: 是的，本项目主要使用中文，提交信息也应使用中文以保持一致性。

### Q: 小修复也需要详细说明吗？

A: 如果变更很小且自解释，可以省略正文。但建议至少包含一行说明。

### Q: 可以修改已推送的提交信息吗？

A: 如果提交还未合并到主分支，可以使用 `git commit --amend` 修改。如果已合并，不建议修改（除非是明显的错误）。

### Q: 如何写好的提交信息？

A: 想象你在向未来的自己（或团队成员）解释这个变更。包含：
- **做了什么**（What）
- **为什么做**（Why）
- **如何验证**（How to test）

## 参考资源

- [Google Engineering Practices - The CL Author's Guide](https://google.github.io/eng-practices/review/developer/)
- [How to Write a Git Commit Message](https://chris.beams.io/posts/git-commit/)
- [Conventional Commits](https://www.conventionalcommits.org/)（可选参考）

