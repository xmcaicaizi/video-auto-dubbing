# 🔄 迁移方案更新说明

> **更新时间**: 2026-02-02
> **原因**: 根据实际需求调整 ASR 和 TTS 方案

---

## 📢 重要变更

基于你的反馈，迁移方案已作出以下调整：

### 1️⃣ ASR 方案变更

**原计划**: 使用阿里云百炼的 `qwen3-asr-flash`
❌ **问题**: 不支持说话人识别

**新方案**: 使用阿里云百炼的 **Qwen-Audio** (Multimodal API)
✅ **优势**:
- ✅ 原生支持**时间戳**
- ✅ 原生支持**说话人识别** (Speaker Diarization)
- ✅ 高质量转写
- ✅ 统一在百炼平台管理

**API 地址**: https://bailian.console.aliyun.com/cn-beijing/#/api/?type=model&url=2978300

**⚠️ 待确认信息**:
- API 响应格式详情
- 说话人识别的具体参数
- 时间戳精度和格式
- 最大支持说话人数量

### 2️⃣ TTS 方案变更

**原计划**: 使用阿里云百炼的 `qwen-tts-flash` API
❌ **限制**:
- 不支持音色克隆
- 音色选择有限
- 按量计费

**新方案**: **自部署 Qwen3-TTS + FastAPI 服务**
✅ **优势**:
- ✅ **极低延迟**: 首字节 97ms (vs API 200ms+)
- ✅ **音色克隆**: 3秒快速克隆任意音色
- ✅ **自然语言控制**: "更快一点"、"更温柔" 等指令
- ✅ **9种预设音色**: 覆盖中英日韩多语言
- ✅ **完全自主可控**: 无 API 限流
- ✅ **成本可控**: 仅 GPU 成本，无按量计费

**GitHub**: https://github.com/QwenLM/Qwen3-TTS

---

## 📊 更新后的迁移矩阵

| 服务 | 旧方案 | 新方案 | 部署方式 | 成本 |
|-----|--------|--------|---------|------|
| **ASR** | 火山引擎 | **Qwen-Audio** (百炼API) | API调用 | 按量计费 |
| **OSS** | MinIO | **阿里云 OSS** | 托管服务 | 按量计费 |
| **LLM** | 智谱GLM | **DashScope** (百炼API) | API调用 | 按量计费 |
| **TTS** | IndexTTS | **Qwen3-TTS** (自部署) | Docker + GPU | 固定成本 |

---

## 🎯 新的技术架构

```
┌─────────────────────────────────────────────────────────┐
│                  API Gateway (Nginx)                     │
└──────────────────────┬──────────────────────────────────┘
                       │
        ┌──────────────┴──────────────┐
        │                             │
┌───────▼────────┐           ┌────────▼────────┐
│ Worker Service │           │  Web Frontend   │
│  (Go)          │           │                 │
└───┬────┬───┬───┘           └─────────────────┘
    │    │   │
    │    │   └─────────────────────┐
    │    │                         │
    │    │   ┌─────────────────────▼───────────────┐
    │    │   │  Qwen3-TTS Service (自部署)         │
    │    │   │  - FastAPI                          │
    │    │   │  - Docker + GPU                     │
    │    │   │  - 9种预设音色 + 音色克隆           │
    │    │   └─────────────────────────────────────┘
    │    │
    │    └───────────────────────┐
    │                            │
    │    ┌─────────────────────▼─────────────────┐
    │    │  阿里云 DashScope LLM (API)           │
    │    │  - qwen-turbo 翻译                    │
    │    └───────────────────────────────────────┘
    │
    └────────────────────────┐
                             │
    ┌────────────────────────▼────────────────────┐
    │  阿里云 Qwen-Audio ASR (API)                │
    │  - 时间戳 + 说话人识别                      │
    └─────────────────────────────────────────────┘

    ┌─────────────────────────────────────────────┐
    │  阿里云 OSS (对象存储)                      │
    │  - 视频、音频、结果文件                     │
    └─────────────────────────────────────────────┘
```

---

## ⏱️ 调整后的时间线

### Phase 1: ASR 迁移 (3天) → **4天**

**变更**: 需要调研和实现 Qwen-Audio 客户端

- Day 1: 调研 Qwen-Audio API，获取详细文档
- Day 2: 实现 `qwen_audio_client.go`
- Day 3: 单元测试和集成测试
- Day 4: 性能对比测试，文档更新

### Phase 4: TTS 迁移 (3天) → **5天**

**变更**: 需要从零开始实现 FastAPI 服务

- Day 1-2: 实现 FastAPI TTS 服务
  - 模型加载和管理
  - API 路由设计
  - 并发控制
- Day 3: 实现 Go 客户端
- Day 4: Docker 化和部署
- Day 5: 性能优化和测试

**新的总工期**: 14天 → **16天**

---

## 📝 需要补充的文档

已创建以下新文档：

1. ✅ **ASR_API_RESEARCH.md** - Qwen-Audio API 调研
2. ✅ **TTS_QWEN3_DEPLOYMENT.md** - Qwen3-TTS 完整部署方案（含代码）

待创建：

3. ⏸️ **QWEN_AUDIO_INTEGRATION.md** - Qwen-Audio 集成详细文档（等 API 细节确认）

---

## 🎯 立即行动

### ASR 方面

**需要你提供**:
1. Qwen-Audio API 的完整响应格式示例
2. 说话人识别的触发方式（自动？prompt？）
3. 时间戳的精度和格式
4. 计费方式

**提供方式**:
```bash
# 方式1: 复制 API 文档页面的文本内容
# 方式2: 提供实际 API 调用的 JSON 响应
# 方式3: 截图关键信息
```

### TTS 方面

**已完成**:
- ✅ FastAPI 服务完整代码
- ✅ Go 客户端代码
- ✅ Docker 部署配置
- ✅ 音色映射方案
- ✅ 性能优化建议

**可以开始**:
```bash
# 创建 TTS 服务目录
cd /Users/micago/Desktop/index/video-auto-dubbing
mkdir -p tts_service/app/{models,services,routers,utils}

# 复制代码（从文档中）
# 详见 docs/migration/TTS_QWEN3_DEPLOYMENT.md
```

---

## 💰 成本对比

### 原计划（全API方案）

| 服务 | 月成本估算 |
|-----|-----------|
| ASR | $50-100 |
| OSS | $20-40 |
| LLM | $30-60 |
| TTS | $80-150 |
| **总计** | **$180-350/月** |

### 新方案（混合方案）

| 服务 | 月成本估算 |
|-----|-----------|
| ASR (Qwen-Audio API) | $50-100 |
| OSS | $20-40 |
| LLM (DashScope API) | $30-60 |
| TTS (自部署 GPU) | $100-150 (GPU租赁) |
| **总计** | **$200-350/月** |

**成本差异不大，但自部署 TTS 带来**:
- ✅ 更低延迟（97ms vs 200ms+）
- ✅ 音色克隆能力
- ✅ 无 API 限流
- ✅ 完全自主可控

---

## 🔍 风险评估

### 新增风险

| 风险 | 影响 | 缓解措施 |
|-----|------|---------|
| Qwen-Audio API 信息不全 | 🟡 中 | 提前调研，准备备选方案(火山引擎) |
| Qwen3-TTS GPU 需求 | 🟡 中 | 选择 1.7B 模型，约6GB VRAM |
| FastAPI 服务稳定性 | 🟡 中 | 完善错误处理，添加监控 |
| 模型下载时间 | 🟢 低 | 首次部署预留时间 |

### 原有风险保持不变

- API 配额管理
- 数据迁移风险
- 性能达标风险

---

## ✅ 下一步

1. **ASR**: 请提供 Qwen-Audio API 详细信息
2. **TTS**: 开始实现 FastAPI 服务（代码已就绪）
3. **整体**: 更新 worktree 初始化脚本和任务清单

---

**更新记录**:
- 2026-02-02: 根据用户反馈调整 ASR 和 TTS 方案
- 添加 Qwen-Audio 和 Qwen3-TTS 详细文档

**状态**: ✅ 方案更新完成，等待 ASR API 详情确认
